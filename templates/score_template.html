# Add this new route in web_interface.py:

@app.route('/reports/live.html')
def show_report():
    try:
        # Get parameters from query string
        callsign = request.args.get('callsign')
        contest = request.args.get('contest')
        filter_type = request.args.get('filter_type')
        filter_value = request.args.get('filter_value')

        if not (callsign and contest):
            return render_template('error.html', error="Missing required parameters")

        logger.info(f"Refreshing report for: callsign={callsign}, contest={contest}, "
                   f"filter_type={filter_type}, filter_value={filter_value}")

        reporter = ScoreReporter(Config.DB_PATH)
        stations = reporter.get_station_details(callsign, contest, filter_type, filter_value)

        if stations:
            success = reporter.generate_html(callsign, contest, stations, Config.OUTPUT_DIR)
            if success:
                return send_from_directory(Config.OUTPUT_DIR, 'live.html')
            else:
                return render_template('error.html', error="Failed to generate report")
        else:
            return render_template('error.html', error="No data found for the selected criteria")

    except Exception as e:
        logger.error("Exception in show_report:")
        logger.error(traceback.format_exc())
        return render_template('error.html', error=f"Error: {str(e)}")

# Modify the POST handling in the index route to redirect with parameters:
if request.method == 'POST' and request.form.get('callsign'):
    callsign = request.form.get('callsign')
    contest = request.form.get('contest')
    filter_type = request.form.get('filter_type')
    filter_value = request.form.get('filter_value')
    
    # Build query parameters for redirect
    params = {
        'callsign': callsign,
        'contest': contest
    }
    if filter_type and filter_value:
        params['filter_type'] = filter_type
        params['filter_value'] = filter_value
    
    # Redirect to the report with parameters
    return redirect(url_for('show_report', **params))
    
