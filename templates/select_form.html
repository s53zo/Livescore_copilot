<!DOCTYPE html>
<html>
<head>
    <title>Livescore Pilot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- React and ReactDOM -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ContestForm Component
        const ContestForm = () => {
            const [contests, setContests] = useState([]);
            const [selectedContest, setSelectedContest] = useState('');
            const [callsigns, setCallsigns] = useState([]);
            const [selectedCallsign, setSelectedCallsign] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            // Fetch contests on component mount
            React.useEffect(() => {
                fetchContests();
            }, []);

            // Fetch callsigns when contest is selected
            React.useEffect(() => {
                if (selectedContest) {
                    fetchCallsigns(selectedContest);
                }
            }, [selectedContest]);

            const fetchContests = async () => {
                try {
                    const response = await fetch('/livescore-pilot/api/contests');
                    if (!response.ok) throw new Error('Failed to fetch contests');
                    const data = await response.json();
                    setContests(data);
                } catch (err) {
                    setError('Error loading contests');
                    console.error(err);
                }
            };

            const fetchCallsigns = async (contest) => {
                setLoading(true);
                try {
                    const response = await fetch(`/livescore-pilot/api/callsigns?contest=${encodeURIComponent(contest)}`);
                    if (!response.ok) throw new Error('Failed to fetch callsigns');
                    const data = await response.json();
                    setCallsigns(data);
                    setError('');
                } catch (err) {
                    setError('Error loading callsigns');
                    console.error(err);
                } finally {
                    setLoading(false);
                }
            };

            const handleContestChange = (e) => {
                setSelectedContest(e.target.value);
                setSelectedCallsign(''); // Reset callsign when contest changes
            };

            const handleCallsignChange = (e) => {
                setSelectedCallsign(e.target.value);
            };

            const handleSubmit = () => {
                if (selectedContest && selectedCallsign) {
                    window.location.href = `/reports/live.html?contest=${encodeURIComponent(selectedContest)}&callsign=${encodeURIComponent(selectedCallsign)}`;
                }
            };

            return (
                <div className="max-w-2xl mx-auto p-4">
                    <div className="bg-white rounded-lg shadow p-6">
                        <h1 className="text-2xl font-bold mb-6">Livescore Pilot</h1>
                        
                        {error && (
                            <div className="bg-red-50 text-red-600 p-3 rounded-md mb-4">
                                {error}
                            </div>
                        )}

                        <div className="space-y-6">
                            {/* Contest Selection */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Select Contest
                                </label>
                                <select
                                    value={selectedContest}
                                    onChange={handleContestChange}
                                    className="w-full p-2 border rounded-md bg-white"
                                >
                                    <option value="">-- Select Contest --</option>
                                    {contests.map(contest => (
                                        <option key={contest.name} value={contest.name}>
                                            {contest.name} ({contest.count} OPs)
                                        </option>
                                    ))}
                                </select>
                            </div>

                            {/* Callsign Selection */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Select Callsign
                                </label>
                                <select
                                    value={selectedCallsign}
                                    onChange={handleCallsignChange}
                                    disabled={!selectedContest || loading}
                                    className="w-full p-2 border rounded-md bg-white"
                                >
                                    <option value="">-- Select Callsign --</option>
                                    {callsigns.map(call => (
                                        <option key={call.name} value={call.name}>
                                            {call.name} ({call.qso_count} QSOs)
                                        </option>
                                    ))}
                                </select>
                                {loading && (
                                    <div className="text-sm text-gray-500 mt-1">Loading callsigns...</div>
                                )}
                            </div>

                            {/* Generate Report Button */}
                            <button
                                onClick={handleSubmit}
                                disabled={!selectedContest || !selectedCallsign}
                                className="w-full bg-green-600 text-white p-3 rounded-md hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                Generate Report
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Mount the React application
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ContestForm />);
    </script>
</body>
</html>
