<!DOCTYPE html>
<html>
<head>
    <title>Livescore Pilot</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
</head>
<body>
    <div id="root">Loading...</div>

    <script type="text/javascript">
        const initialData = {
            contests: {{ contests | tojson | safe }},
            selectedContest: {{ selected_contest | tojson | safe if selected_contest else 'null' }},
            selectedCallsign: {{ selected_callsign | tojson | safe if selected_callsign else 'null' }},
            initialCallsigns: {{ callsigns | tojson | safe }}
        };

        const FilterSelectionForm = () => {
            const [contests, setContests] = React.useState(initialData.contests || []);
            const [selectedContest, setSelectedContest] = React.useState(initialData.selectedContest || '');
            const [callsigns, setCallsigns] = React.useState(initialData.initialCallsigns || []);
            const [selectedCallsign, setSelectedCallsign] = React.useState(initialData.selectedCallsign || '');
            const [loading, setLoading] = React.useState(false);
            const [error, setError] = React.useState(null);

            React.useEffect(() => {
                if (selectedContest) {
                    console.log('Fetching callsigns for contest:', selectedContest);
                    setLoading(true);
                    setError(null);

                    fetch(`/api/contest/callsigns?contest=${encodeURIComponent(selectedContest)}`)
                        .then(res => {
                            console.log('Callsigns response status:', res.status);
                            if (res.status === 404) {
                                throw new Error('API endpoint not found (404). Please check the server configuration.');
                            }
                            if (!res.ok) {
                                throw new Error(`HTTP error! status: ${res.status}`);
                            }
                            return res.json();
                        })
                        .then(data => {
                            console.log('Received callsigns data:', data);
                            if (Array.isArray(data)) {
                                setCallsigns(data);
                            } else {
                                console.error('Invalid callsigns data format:', data);
                                setError('Invalid data format received from server');
                            }
                        })
                        .catch(err => {
                            console.error('Error fetching callsigns:', err);
                            setError(err.message);
                        })
                        .finally(() => {
                            setLoading(false);
                        });
                } else {
                    setCallsigns([]);
                    setSelectedCallsign('');
                }
            }, [selectedContest]);

            const handleContestChange = (e) => {
                const newContest = e.target.value;
                console.log('Contest selected:', newContest);
                setSelectedContest(newContest);
                setSelectedCallsign('');
                setError(null);
            };

            const handleCallsignChange = (e) => {
                console.log('Callsign selected:', e.target.value);
                setSelectedCallsign(e.target.value);
            };

            return (
                <div className="max-w-2xl mx-auto p-6">
                    <h1 className="text-2xl font-bold mb-6">Livescore Pilot</h1>
                    <p className="mb-6">Online tool to follow your progress on the Contest Livescores.</p>

                    {% if error %}
                        <div style="color: red; margin-bottom: 20px;">Error: {{ error }}</div>
                    {% endif %}

                    <div className="space-y-6">
                        {/* Step 1: Contest Selection */}
                        <div className="p-6 border rounded-lg bg-white shadow-sm">
                            <h2 className="text-lg font-semibold text-green-700 mb-4">Step 1: Select Contest</h2>
                            <select
                                className="w-full p-2 border rounded"
                                value={selectedContest}
                                onChange={handleContestChange}
                            >
                                <option value="">-- Select Contest --</option>
                                {contests.map(contest => (
                                    <option key={contest.name} value={contest.name}>
                                        {contest.name} ({contest.count} OPs)
                                    </option>
                                ))}
                            </select>
                        </div>

                        {/* Step 2: Callsign Selection */}
                        <div className={`p-6 border rounded-lg bg-white shadow-sm ${!selectedContest ? 'opacity-50' : ''}`}>
                            <h2 className="text-lg font-semibold text-green-700 mb-4">Step 2: Select Callsign</h2>
                            {loading ? (
                                <p className="text-gray-600">Loading callsigns...</p>
                            ) : error ? (
                                <p className="text-red-600">{error}</p>
                            ) : (
                                <select
                                    className="w-full p-2 border rounded"
                                    value={selectedCallsign}
                                    onChange={handleCallsignChange}
                                    disabled={!selectedContest || loading}
                                >
                                    <option value="">-- Select Callsign --</option>
                                    {callsigns.map(call => (
                                        <option key={call.name} value={call.name}>
                                            {call.name} ({call.qso_count} QSOs)
                                        </option>
                                    ))}
                                </select>
                            )}
                        </div>

                        {/* Display footer */}
                        <p className="mt-8 text-sm text-gray-600 text-center">
                            Code by Simon, S53ZO and his LLM friend, contest data from competitors via Contest score distribution network
                        </p>
                    </div>
                </div>
            );
        };

        // Mount the React component
        ReactDOM.render(<FilterSelectionForm />, document.getElementById('root'));
    </script>
</body>
</html>
