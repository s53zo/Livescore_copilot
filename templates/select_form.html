import React, { useState, useEffect } from 'react';
import { Card, CardContent } from '@/components/ui/card';

const ContestForm = () => {
  const [contests, setContests] = useState([]);
  const [selectedContest, setSelectedContest] = useState('');
  const [callsigns, setCallsigns] = useState([]);
  const [selectedCallsign, setSelectedCallsign] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  // Fetch contests on component mount
  useEffect(() => {
    fetchContests();
  }, []);

  // Fetch callsigns when contest is selected
  useEffect(() => {
    if (selectedContest) {
      fetchCallsigns(selectedContest);
    }
  }, [selectedContest]);

  const fetchContests = async () => {
    try {
      const response = await fetch('/livescore-pilot/api/contests');
      if (!response.ok) throw new Error('Failed to fetch contests');
      const data = await response.json();
      setContests(data);
    } catch (err) {
      setError('Error loading contests');
      console.error(err);
    }
  };

  const fetchCallsigns = async (contest) => {
    setLoading(true);
    try {
      const response = await fetch(`/livescore-pilot/api/callsigns?contest=${encodeURIComponent(contest)}`);
      if (!response.ok) throw new Error('Failed to fetch callsigns');
      const data = await response.json();
      setCallsigns(data);
      setError('');
    } catch (err) {
      setError('Error loading callsigns');
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  const handleContestChange = (e) => {
    setSelectedContest(e.target.value);
    setSelectedCallsign(''); // Reset callsign when contest changes
  };

  const handleCallsignChange = (e) => {
    setSelectedCallsign(e.target.value);
  };

  const handleSubmit = () => {
    if (selectedContest && selectedCallsign) {
      window.location.href = `/reports/live.html?contest=${encodeURIComponent(selectedContest)}&callsign=${encodeURIComponent(selectedCallsign)}`;
    }
  };

  return (
    <div className="max-w-2xl mx-auto p-4">
      <Card>
        <CardContent className="p-6">
          <h1 className="text-2xl font-bold mb-6">Livescore Pilot</h1>
          
          {error && (
            <div className="bg-red-50 text-red-600 p-3 rounded-md mb-4">{error}</div>
          )}

          <div className="space-y-6">
            {/* Contest Selection */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Select Contest
              </label>
              <select
                value={selectedContest}
                onChange={handleContestChange}
                className="w-full p-2 border rounded-md bg-white"
              >
                <option value="">-- Select Contest --</option>
                {contests.map(contest => (
                  <option key={contest.name} value={contest.name}>
                    {contest.name} ({contest.count} OPs)
                  </option>
                ))}
              </select>
            </div>

            {/* Callsign Selection */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Select Callsign
              </label>
              <select
                value={selectedCallsign}
                onChange={handleCallsignChange}
                disabled={!selectedContest || loading}
                className="w-full p-2 border rounded-md bg-white"
              >
                <option value="">-- Select Callsign --</option>
                {callsigns.map(call => (
                  <option key={call.name} value={call.name}>
                    {call.name} ({call.qso_count} QSOs)
                  </option>
                ))}
              </select>
            </div>

            {/* Generate Report Button */}
            <button
              onClick={handleSubmit}
              disabled={!selectedContest || !selectedCallsign}
              className="w-full bg-green-600 text-white p-3 rounded-md hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Generate Report
            </button>
          </div>
        </CardContent>
      </Card>
    </div>
  );
};

export default ContestForm;
